<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projects Management</title>
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3133/3133158.png" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app-container">
        <!-- Navbar -->
        <header>
            <div class="header-left">
                <img src="https://cdn-icons-png.flaticon.com/512/3133/3133158.png" alt="Logo" class="header-logo">
                <h1 class="hide-mobile" id="title-pj">Projects Management</h1>
                <nav class="header-nav">
                    <a href="time_tracker.html" class="nav-link"><i class="fas fa-clock"></i> <span class="hide-mobile">Time Tracker</span></a>
                    <a href="projects.html" class="nav-link active"><i class="fas fa-project-diagram"></i> 
                    <span class="hide-mobile">Pipeline</span></a>
                </nav>
            </div>
            <div class="header-right">
                <button id="dark-mode-toggle" class="icon-btn"><i class="fas fa-moon"></i></button>
                <div class="user-menu-container">
                    <button id="user-menu-btn" class="user-menu-trigger">
                        <span id="header-username">User</span>
                        <img id="header-avatar" src="" alt="Avatar" class="avatar-placeholder">
                        <i class="fas fa-chevron-down arrow-icon"></i>
                    </button>

                    <div id="user-dropdown" class="dropdown-menu hidden">
                        <div class="dropdown-header">
                            <strong id="dropdown-name">Name</strong>
                            <span id="dropdown-email">email@dhl.com</span>
                        </div>
                        <hr>
                        <a href="#" class="dropdown-item" id="open-unified-modal"><i class="fas fa-user-cog"></i> Editar Perfil & Conta</a>
                        <hr>
                        <a href="index.html" class="dropdown-item text-danger" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Sair</a>
                    </div>
                </div>
            </div>
        </header>

        <main class="container fluid-container">
            <!-- Stats -->
            <section class="stats-row" id="visuais">
                <div class="card stat-card">
                    <div class="stat-icon bg-blue"><i class="fas fa-tasks"></i></div>
                    <div class="stat-info"><h3>Total Projetos</h3><span id="total-projects">0</span></div>
                </div>
                <div class="card stat-card">
                    <div class="stat-icon bg-yellow"><i class="fas fa-spinner"></i></div>
                    <div class="stat-info"><h3>Em Andamento</h3><span id="active-projects">0</span></div>
                </div>
                <div class="card stat-card">
                    <div class="stat-icon bg-green"><i class="fas fa-dollar-sign"></i></div>
                    <div class="stat-info"><h3>Monetização Est.</h3><span id="total-money">R$ 0,00</span></div>
                </div>
            </section>

            <!-- Tabela -->
            <section class="card" id="pj_tbl">
                <!-- projects.html (Dentro da section class="card") -->

                <div class="table-toolbar">
                    <div class="toolbar-left">
                        <!-- 1. O Botão fica fora do wrapper de inputs -->
                        <button id="toggle-filters-btn" class="btn btn-secondary mobile-filter-toggle">
                            <i class="fas fa-filter"></i> Filtrar e Buscar <i class="fas fa-chevron-down" id="filter-icon"></i>
                        </button>

                        <!-- 2. Os Inputs ficam dentro desta nova div 'filter-wrapper' -->
                        <div id="projects-filter-wrapper" class="filter-wrapper">
                            <!-- Busca -->
                            <div class="input-wrapper">
                                <input type="text" id="search-project" placeholder="Buscar projeto..." class="filter-control search-small">
                            </div>
                            
                            <!-- Filtros -->
                            <select id="filter-status" class="filter-control styled-select-small">
                                <option value="">Status: All</option>
                                <option value="Not Started">Não Iniciado</option>
                                <option value="In Progress">Em Andamento</option>
                                <option value="On Hold">Em Espera</option>
                                <option value="Completed">Concluído</option>
                                <option value="Cancelled">Cancelado</option>
                            </select>

                            <select id="filter-user" class="filter-control styled-select-small">
                                <option value="">Responsible: All</option>
                            </select>

                            <select id="filter-area" class="filter-control styled-select-small">
                                <option value="">Area: All</option>
                            </select>
                        </div>
                    </div>

                    <div class="toolbar-right">
                        <button id="btn-new-project" class="btn btn-primary"><i class="fas fa-plus"></i> Novo</button>
                        <button id="btn-export-projects" class="btn btn-outline-success"><i class="fas fa-file-excel"></i> Excel</button>
                    </div>
                </div>

                <div class="table-responsive x-scroll">
                    <table class="data-table small-font" id="projects-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Project</th>
                                <th>Site</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Category</th>
                                <th>Area</th>
                                <th>Complexity</th>
                                <th>Requester</th>
                                <th>Resp.</th>
                                <th>Start</th>
                                <th>Delivery</th>
                                <th>Est. Hours</th>
                                <th>$</th>
                                <th>Comments</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </main>
        
        <footer class="app-footer"><p>DHL Projects &copy; 2025</p></footer>
    </div>

    <!-- Modal Novo/Editar Projeto -->
    <div id="project-modal" class="modal hidden">
        <div class="modal-content large-modal">
            <div class="modal-header"><h3 id="modal-title">Novo Projeto</h3><button class="close-modal">&times;</button></div>
            <form id="project-form">
                <div class="modal-body">
                    <input type="hidden" id="p-id">
                    <div class="form-row">
                        <div class="form-group"><label>Nome do Projeto *</label><input type="text" id="p-name" required></div>
                        <div class="form-group"><label>Site / Local *</label><input type="text" id="p-site" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Status</label>
                            <select id="p-status" class="styled-select">
                                <option value="Not Started">Não Iniciado</option>
                                <option value="In Progress">Em Andamento</option>
                                <option value="On Hold">Em Espera</option>
                                <option value="Completed">Concluído</option>
                                <option value="Cancelled">Cancelado</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Progresso (%)</label><input type="number" id="p-progress" min="0" max="100" value="0"></div>
                        <div class="form-group"><label>Complexidade</label>
                            <select id="p-complexity" class="styled-select">
                                <option value="Low">Baixa</option>
                                <option value="Medium">Média</option>
                                <option value="High">Alta</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Categoria</label>
                            <select id="p-category" class="styled-select">
                                <option value="Development">Development</option>
                                <option value="Governance">Governance</option>
                                <option value="Change">Change</option>
                                <option value="Maintenance">Maintenance</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Área</label>
                            <select id="p-area" class="styled-select">
                                <option value="Digitalização">Digitalização</option>
                                <option value="Sistemas Operacionais">Sistemas Operacionais</option>
                            </select>
                        </div>  
                        <div class="form-group"><label>Sistema Utilizado</label><input type="text" id="p-system"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Owner</label><input type="text" id="p-owner"></div>
                        <div class="form-group"><label>Responsável</label><input type="text" id="p-responsible"></div>
                        <div class="form-group"><label>Solicitante</label><input type="text" id="p-requester"></div>
                    </div>
                    <h4 class="separator"><small>Datas & Estimativas</small></h4>
                    <div class="form-row">
                        <div class="form-group"><label>Data Início</label><input type="date" id="p-start-date" required></div>
                        <div class="form-group"><label>Deadline</label><input type="date" id="p-deadline"></div>
                        <div class="form-group"><label>Data Conclusão</label><input type="date" id="p-completion-date"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Horas Est. (Mês)</label><input type="number" id="p-hours" step="0.5"></div>
                        <div class="form-group"><label>Est. Monetização (R$)</label><input type="number" id="p-money" step="0.01"></div>
                    </div>
                    <div class="form-group"><label>Comentários</label><textarea id="p-comments" rows="3"></textarea></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal-btn">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Projeto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Perfil Unificado (Cópia exata do Time Tracker) -->
    <div id="unified-profile-modal" class="modal hidden">
        <div class="modal-content large-modal">
            <div class="modal-header"><h3>Perfil</h3><button class="close-modal">&times;</button></div>
            <form id="unified-profile-form">
                <div class="modal-body profile-grid">
                    <div class="profile-left">
                        <div class="profile-avatar-large">
                            <img id="profile-image-large" src="" alt="Avatar">
                            <label for="profile-image-input" class="edit-avatar-btn"><i class="fas fa-camera"></i></label>
                            <input type="file" id="profile-image-input" class="hidden" accept="image/*">
                        </div>
                        <div class="form-group mt-2"><label>Nome</label><input type="text" id="edit-name"></div>
                        <div class="form-group"><label>Bio</label><textarea id="edit-bio" rows="3"></textarea></div>
                    </div>
                    <div class="profile-right">
                        <div class="form-row">
                            <div class="form-group"><label>Depto</label><input type="text" id="edit-dept"></div>
                            <div class="form-group"><label>Cargo</label><input type="text" id="edit-role"></div>
                        </div>
                        <div class="form-group"><label>Telefone</label><input type="text" id="edit-phone"></div>
                        <div class="security-zone">
                            <h4 style="margin-bottom:10px; border-bottom:1px solid #ddd;">Conta</h4>
                            <div class="form-group"><label>E-mail</label><input type="email" id="edit-email" required></div>
                            <div class="form-group"><label>Nova Senha</label><input type="password" id="edit-new-password"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary close-modal-btn">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NOVO: Modal para Visualizar Comentários -->
    <div id="comment-view-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-comment-alt"></i> Comentários do Projeto</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="full-comment-text" style="white-space: pre-wrap; line-height: 1.6; color: var(--text-main);"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-modal-btn">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação de Exclusão (Redesign) -->
    <div id="delete-confirm-modal" class="modal hidden">
        <div class="modal-content delete-modal-content">
            <div class="modal-body text-center">
                <!-- Ícone Animado -->
                <div class="delete-icon-wrapper">
                    <i class="fas fa-trash-alt"></i>
                </div>
                
                <!-- Textos -->
                <h3 class="delete-title">Excluir Projeto?</h3>
                <p class="delete-text">Você está prestes a remover este registro permanentemente.</p>
                <p class="delete-warning"><i class="fas fa-exclamation-circle"></i> Essa ação não pode ser desfeita.</p>
                
                <!-- Botões -->
                <div class="delete-actions">
                    <button type="button" class="btn btn-secondary close-modal-btn">Cancelar</button>
                    <button type="button" id="confirm-delete-btn" class="btn btn-danger">Sim, Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- === NOVOS MODAIS DE SEGURANÇA === -->

    <!-- 1. Modal para Exigir Senha -->
    <div id="password-challenge-modal" class="modal hidden" style="z-index: 3000;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" style="background: #333; color: white;">
                <h3><i class="fas fa-lock"></i> Segurança</h3>
                <button class="close-modal close-challenge-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--text-muted);">Para salvar as alterações, por favor confirme sua senha atual:</p>
                <div class="form-group">
                    <div class="input-group">
                        <i class="fas fa-key input-icon"></i>
                        <input type="password" id="challenge-password-input" placeholder="Digite sua senha atual..." required>
                    </div>
                </div>
                <p id="challenge-error" class="hidden" style="color: var(--danger); font-size: 0.85rem; margin-top: 5px;"><i class="fas fa-exclamation-circle"></i> Senha incorreta.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary close-challenge-btn">Cancelar</button>
                <button type="button" id="confirm-save-btn" class="btn btn-primary">Confirmar e Salvar</button>
            </div>
        </div>
    </div>

    <!-- 2. Modal de Sucesso -->
    <div id="success-modal" class="modal hidden" style="z-index: 3001;">
        <div class="modal-content text-center" style="max-width: 350px; padding: 2rem;">
            <div style="font-size: 4rem; color: var(--success); margin-bottom: 1rem;">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 style="color: var(--text-main); margin-bottom: 0.5rem;">Sucesso!</h3>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Seu perfil foi atualizado corretamente.</p>
            <button id="close-all-modals-btn" class="btn btn-success btn-block">OK</button>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/sheetjs-style/dist/xlsx.full.min.js"></script>
    <script src="project_script.js"></script>
</body>
</html>
